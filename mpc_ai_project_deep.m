%% training data
% 학습 패턴이 다양해질 수록 구별하는 능력이 더 다양해진다
% test dataset을 더 만들어서 학습시키면 더 잘 분류해내는 것을 확인할 수 있다

clear all;
rng(3);

%one hot encoding 
Y= [1 0 0 0 0 ; %1;gleason score 6
    0 1 0 0 0 ; %2;gleason score 7
    0 0 1 0 0 ; %3;gleason score 8
    0 0 0 1 0 ; %4;gleason score 9
    0 0 0 0 1 ];%5;gleason score 10

yIndex=[1,1,1,1,1,
        1,1,1,1,1,
        1,1,1,1,1,
        1,1,1,1,1,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,2,2,
        2,2,2,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,3,3,3,
        3,3,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        4,4,4,4,4,
        5,5,5,5,5,
        5,5,5,5,5,
        5,5,5,5,5,];
    
%correct answer for each image
%index to find Y value in MultiClass

U = zeros(1,3,310);%1~5를 각각 1x3로 나타냄 

%gleason score 6
U(:,:,1)=[1 -1 0];
U(:,:,2)=[2 0 -1];     
U(:,:,3)=[2 -1 -1];      
U(:,:,4)=[0 -2 -1];     
U(:,:,5)=[1 0 1];     
U(:,:,6)=[2 -1 -1];
U(:,:,7)=[2 -1 -1];
U(:,:,8)=[2 -2 -1];
U(:,:,9)=[2 -1 -1];    
U(:,:,10)=[0 -1 0];      
U(:,:,11)=[2 -1 -1];
U(:,:,12)=[2 -1 -1];
U(:,:,13)=[1 1 -1];
U(:,:,14)=[2 -1 1];   
U(:,:,15)=[2 -1 -2];
U(:,:,16)=[2 0 0];
U(:,:,17)=[2 -1 0];
U(:,:,18)=[1 -1 0];
U(:,:,19)=[0 0 0];
U(:,:,20)=[0 0 0];
%gleason score 7
U(:,:,21)=[1 0 0];
U(:,:,22)=[2 -1 0];
U(:,:,23)=[0 -2 -2];
U(:,:,24)=[0 0 0];
U(:,:,25)=[0 0 0];
U(:,:,26)=[2 -1 0];
U(:,:,27)=[2 0 0];
U(:,:,28)=[2 -2 0];
U(:,:,29)=[1 0 0];
U(:,:,30)=[0 0 -1];
U(:,:,31)=[2 0 0];
U(:,:,32)=[2 -1 -1];
U(:,:,33)=[2 -1 0];
U(:,:,34)=[2 0 0];
U(:,:,35)=[0 0 -1];
U(:,:,36)=[0 -1	0];
U(:,:,37)=[0 -1	-1];
U(:,:,38)=[1 -1 -1];
U(:,:,39)=[2 0 0];
U(:,:,40)=[2 -1 -1];
U(:,:,41)=[1 0 0];
U(:,:,42)=[2 0 0];
U(:,:,43)=[2 -2 -1];
U(:,:,44)=[1 -1	-1];
U(:,:,45)=[1 0 0];
U(:,:,46)=[0 -1 0];
U(:,:,47)=[0 -1 -1];
U(:,:,48)=[2 0 0];
U(:,:,49)=[0 0 0];
U(:,:,50)=[2 0 0];
U(:,:,51)=[1 -1 -2];
U(:,:,52)=[0 0 0];
U(:,:,53)=[2 -1 -1];
U(:,:,54)=[2 -1 -1];
U(:,:,55)=[2 -1	0];
U(:,:,56)=[0 -2 -1];
U(:,:,57)=[2 -1 -1];
U(:,:,58)=[0 -1 -1];
U(:,:,59)=[2 0 -1];
U(:,:,60)=[2 -1 -1];
U(:,:,61)=[0 -2 -1];
U(:,:,62)=[0 -1 -1];
U(:,:,63)=[2 -1	-1];
U(:,:,64)=[2 -1 -1];
U(:,:,65)=[2 -1	0];
U(:,:,66)=[2 -1 -1];
U(:,:,67)=[2 0 0];
U(:,:,68)=[2 -1 -1];
U(:,:,69)=[2 -1 -1];
U(:,:,70)=[2 0 0];
U(:,:,71)=[2 -2	-1];
U(:,:,72)=[0 0 0];
U(:,:,73)=[1 -1 -1];
U(:,:,74)=[2 -1 -1];
U(:,:,75)=[0 -1	-1];
U(:,:,76)=[2 0 -1];
U(:,:,77)=[2 0 -1];
U(:,:,78)=[0 -1 0];
U(:,:,79)=[1 -1 -1];
U(:,:,80)=[2 -1	0];
U(:,:,81)=[2 -1	-1];
U(:,:,82)=[0 0 -1];
U(:,:,83)=[2 -1 -1];
U(:,:,84)=[0 0 0];
U(:,:,85)=[0 0 0];
U(:,:,86)=[0 0 0];
U(:,:,87)=[1 0 0];
U(:,:,88)=[0 0 1];
U(:,:,89)=[0 0 -1];
U(:,:,90)=[1 -1 0];
U(:,:,91)=[0 0 0];
U(:,:,92)=[0 0 0];
U(:,:,93)=[0 0 0];
U(:,:,94)=[0 0 0];
U(:,:,95)=[0 0 0];
U(:,:,96)=[1 0 -1];
U(:,:,97)=[0 -2	-1];
U(:,:,98)=[2 -1 -1];
U(:,:,99)=[2 -1 0];
U(:,:,100)=[1 0 -1];
U(:,:,101)=[0 0	0];
U(:,:,102)=[2 0	0];
U(:,:,103)=[2 0 -1];
U(:,:,104)=[1 -1 -1];
U(:,:,105)=[2 0	-1];
U(:,:,106)=[2 -1 -1];
U(:,:,107)=[2 -1 -1];
U(:,:,108)=[2 0 0];
U(:,:,109)=[1 -1 -1];
U(:,:,110)=[0 -1 -1];
U(:,:,111)=[2 0 -1];
U(:,:,112)=[0 -1 0];
U(:,:,113)=[1 -1 -1];
U(:,:,114)=[2 0 -1];
U(:,:,115)=[2 -1 -1];
U(:,:,116)=[0 0	0];
U(:,:,117)=[2 0 0];
U(:,:,118)=[0 0	0];
%gleason score 8
U(:,:,119)=[2 0 0];
U(:,:,120)=[0 -1 0];
U(:,:,121)=[2 -2 -1];
U(:,:,122)=[2 -1 -1];
U(:,:,123)=[1 -1 -1];
U(:,:,124)=[2 -1 -1];
U(:,:,125)=[0 -1 -1];
U(:,:,126)=[0 0 0];
U(:,:,127)=[0 -1 -1];
U(:,:,128)=[2 -1 -1];
U(:,:,129)=[1 0 0];
U(:,:,130)=[1 0 -1];
U(:,:,131)=[2 -1 -1];
U(:,:,132)=[0 0 0];
U(:,:,133)=[1 -2 -1];
U(:,:,134)=[0 -1 -1];
U(:,:,135)=[2 -1 -1];
U(:,:,136)=[2 -1 -1];
U(:,:,137)=[1 -2 -1];
U(:,:,138)=[2 -1 -1];
U(:,:,139)=[0 -1 -1];
U(:,:,140)=[2 -1 -1];
U(:,:,141)=[2 -2 -2];
U(:,:,142)=[2	-1	-1];
U(:,:,143)=[1	0	-1];
U(:,:,144)=[1	1	1];
U(:,:,145)=[1	1	1];
U(:,:,146)=[1	-1	-1];
U(:,:,147)=[2	-1	-1];
U(:,:,148)=[2	1	1];
U(:,:,149)=[0	-1	-1];
U(:,:,150)=[1	-2	-1];
U(:,:,151)=[0	0	0];
U(:,:,152)=[0	-1	0];
U(:,:,153)=[2	0	-2];
U(:,:,154)=[2	0	-2];
U(:,:,155)=[2	1	-1];
U(:,:,156)=[1	-1	-1];
U(:,:,157)=[2	-1	0];
U(:,:,158)=[1	1	1];
U(:,:,159)=[0	-1	-1];
U(:,:,160)=[2	1	-1];
U(:,:,161)=[2	-1	-1];
U(:,:,162)=[2	-1	-1];
U(:,:,163)=[2	1	-1];
U(:,:,164)=[2	-2	-1];
U(:,:,165)=[2	0	1];
U(:,:,165)=[0	0	0];
U(:,:,166)=[0	0	0];
U(:,:,167)=[0	-1	0];
U(:,:,168)=[2	-2	-1];
U(:,:,169)=[2	1	-1];
U(:,:,170)=[0	-2	-1];
U(:,:,171)=[2	-1	-1];
U(:,:,172)=[2	-1	-1];
U(:,:,173)=[2	1	-2];
U(:,:,174)=[0	-1	0];
U(:,:,175)=[0	-1	0];
U(:,:,176)=[1	-1	-1];
U(:,:,177)=[2	-1	-1];
%gleason score 9
U(:,:,178)=[2 -1 -1];
U(:,:,179)=[2 1 -1];
U(:,:,180)=[2 -1 -1];
U(:,:,181)=[2 -1 -1];
U(:,:,182)=[1 1 1];
U(:,:,183)=[0 -1 0];
U(:,:,184)=[0 -1 -1];
U(:,:,185)=[2 -1 -1];
U(:,:,186)=[2 -2 -1];
U(:,:,187)=[0 -1 -1];
U(:,:,188)=[0 -1 -1];
U(:,:,189)=[1 0 -1];
U(:,:,190)=[0 -1 -1];
U(:,:,191)=[2 -1 -1];
U(:,:,192)=[2 -1 -1];
U(:,:,193)=[2	-1	-1];
U(:,:,194)=[2	0	0];
U(:,:,195)=[2	-1	-1];
U(:,:,196)=[2	0	0];
U(:,:,197)=[2	-1	-1];
U(:,:,198)=[1	-2	-1];
U(:,:,199)=[0	0	0];
U(:,:,200)=[2	-1	-1];
U(:,:,201)=[1	-1	-1];
U(:,:,202)=[2	0	-1];
U(:,:,203)=[0	0	0];
U(:,:,204)=[0	0	0];
U(:,:,205)=[0	-1	0];
U(:,:,206)=[0	-1	0];
U(:,:,207)=[1	-1	-1];
U(:,:,208)=[2	-1	-1];
U(:,:,209)=[2	-1	-1];
U(:,:,210)=[2	-1	0];
U(:,:,211)=[1	-1	-1];
U(:,:,212)=[2	1	-1];
U(:,:,213)=[2	-1	-1];
U(:,:,214)=[2	-1	-1];
U(:,:,215)=[1	0	0];
U(:,:,216)=[0	0	0];
U(:,:,217)=[0	0	0];
U(:,:,218)=[0	-1	0];
U(:,:,219)=[2	-1	-1];
U(:,:,220)=[1	1	-1];
U(:,:,221)=[0	-1	0];
U(:,:,222)=[2	-1	-1];
U(:,:,223)=[2	-1	-1];
U(:,:,224)=[1	-1	0];
U(:,:,225)=[1	-1	-1];
U(:,:,226)=[0	-1	-1];
U(:,:,227)=[0	0	0];
U(:,:,228)=[2	0	0];
U(:,:,229)=[2	0	-1];
U(:,:,230)=[1	-1	-1];
U(:,:,231)=[2	1	-1];
U(:,:,232)=[2	-1	-1];
U(:,:,233)=[2	0	-1];
U(:,:,234)=[1	-1	-1];
U(:,:,235)=[1	0	0];
U(:,:,236)=[1	-2	-2];
U(:,:,237)=[2	-1	-1];
U(:,:,238)=[2	-1	-1];
U(:,:,239)=[2	0	-2];
U(:,:,240)=[0	-1	-1];
U(:,:,241)=[2	-1	-1];
U(:,:,242)=[2	0	-1];
U(:,:,243)=[0	-1	-1];
U(:,:,244)=[0	-1	-1];
U(:,:,245)=[0	-1	-1];
U(:,:,246)=[2	-2	-2];
U(:,:,247)=[2	0	-1];
U(:,:,248)=[2	-1	-1];
U(:,:,249)=[2	0	-1];
U(:,:,250)=[2	-1	-1];
U(:,:,251)=[2	0	1];
U(:,:,252)=[0	-1	0];
U(:,:,253)=[0	-1	0];
U(:,:,254)=[1	-2	0];
U(:,:,255)=[1	-2	0];
U(:,:,256)=[2	1	1];
U(:,:,257)=[1	-1	-1];
U(:,:,258)=[1	-1	0];
U(:,:,259)=[0	-1	0];
U(:,:,260)=[2	1	-1];
U(:,:,261)=[2	0	1];
U(:,:,262)=[0	-2	-1];
U(:,:,263)=[2	-1	-1];
U(:,:,264)=[2	-1	1];
U(:,:,265)=[1	0	0];
U(:,:,266)=[0	-2	-1];
U(:,:,267)=[1	0	0];
U(:,:,268)=[2	0	0];
U(:,:,269)=[0	-1	0];
U(:,:,270)=[2	0	0];
U(:,:,271)=[2	-1	0];
U(:,:,272)=[1	-1	-1];
U(:,:,273)=[0	-1	-1];
U(:,:,274)=[1	0	0];
U(:,:,275)=[2	0	0];
U(:,:,276)=[0	0	0];
U(:,:,277)=[0	0	0];
U(:,:,278)=[2	0	0];
U(:,:,279)=[1	0	0];
U(:,:,280)=[1	0	0];
U(:,:,281)=[1	0	0];
U(:,:,282)=[1	-1	0];
U(:,:,283)=[1 1 2];
U(:,:,284)=[0 0 0];
U(:,:,285)=[1 -2 1];
U(:,:,286)=[1 -2 0];
U(:,:,287)=[1 -2 1];
U(:,:,288)=[1 0 -1];
U(:,:,289)=[1 -1 1];
U(:,:,290)=[1 0	0];
U(:,:,291)=[2 0 0];
U(:,:,292)=[0 -1 0];
U(:,:,293)=[0 -1 0];
U(:,:,294)=[2 0	0];
U(:,:,295)=[2 0 0];
%gleason score 10
U(:,:,296)=[1 0 0];
U(:,:,297)=[2 0 -1];
U(:,:,298)=[2 -1 0];
U(:,:,299)=[1 1 -1];
U(:,:,300)=[2 -1 -2];
U(:,:,301)=[2 -1 -1];
U(:,:,302)=[2 1 -1];
U(:,:,303)=[0 1 -1];
U(:,:,304)=[0 0 0];
U(:,:,305)=[0 0 0];
U(:,:,306)=[0 0 -1];
U(:,:,307)=[1 0 0];
U(:,:,308)=[2 1 -1];
U(:,:,309)=[0 -1 -1];
U(:,:,310)=[1 0 -1];

%% training

% HE uniform weight initialization
 W1 = (2*rand(3,50)-1)*sqrt(12/53);
 W2 = (2*rand(50,50)-1)*sqrt(12/100);
 W3 = (2*rand(50,50)-1)*sqrt(12/100);
 W4 = (2*rand(50,50)-1)*sqrt(12/100);
 W5 = (2*rand(50,50)-1)*sqrt(12/100);
 W6 = (2*rand(50,50)-1)*sqrt(12/100);
 W7 = (2*rand(50,50)-1)*sqrt(12/100);
 W8 = (2*rand(50,50)-1)*sqrt(12/100);
 W9 = (2*rand(50,50)-1)*sqrt(12/100);
 W10 = (2*rand(50,50)-1)*sqrt(12/100);
 W11 = (2*rand(50,5)-1)*sqrt(12/55);

N=size(U,3);
iteration=100;
%e_hist=zeros(5,N);
%y_hist=zeros(5,N);

ee=zeros(N,1);
for epoch = 1:iteration
    [W1,W2,W3,W4,W5,W6,W7,W8,W9,W10,W11,eHist] = MultiClass_mpc_deep(W1,W2,W3,W4,W5,W6,W7,W8,W9,W10,W11,U,Y,N,yIndex);
    for j=1:N
        ee(j,epoch)=sum(abs(eHist(1:5,j)))';
    end
end

for k=1:N
    u=reshape(U(:,:,k),3,1); %reshape 3x1 matrix
    
    z1=W1'*u;
    x1=LeakyReLU(z1);
    
    z2=W2'*x1;
    x2=LeakyReLU(z2);
    
    z3=W3'*x2;
    x3=LeakyReLU(z3);
   
    z4=W4'*x3;
    x4=LeakyReLU(z4);
   
    z5=W5'*x4;
    x5=LeakyReLU(z5);
   
    z6=W6'*x5;
    x6=LeakyReLU(z6);
   
    z7=W7'*x6;
    x7=LeakyReLU(z7);
   
    z8=W8'*x7;
    x8=LeakyReLU(z8);
   
    z9=W9'*x8;
    x9=LeakyReLU(z9);
    
    z10=W10'*x9;
    x10=LeakyReLU(z10);
   
    z11=W11'*x10;
    
    yhat=Softmax(z11)
    
    y_hist(:,k)=yhat;
    
end
 
disp('-------------------------training')

%% plot

figure()
set(0,'DefaultAxesColorOrder',hsv(N));%colorful
endplot=iteration;

iter=1:310
plot(1:endplot,ee(iter,1:endplot))

%{
plot(1:endplot,ee(1,1:endplot))
hold on
plot(1:endplot,ee(2,1:endplot))
plot(1:endplot,ee(3,1:endplot))
plot(1:endplot,ee(4,1:endplot))
plot(1:endplot,ee(5,1:endplot))
plot(1:endplot,ee(6,1:endplot))
plot(1:endplot,ee(7,1:endplot))
plot(1:endplot,ee(8,1:endplot))
plot(1:endplot,ee(9,1:endplot))
plot(1:endplot,ee(10,1:endplot))
plot(1:endplot,ee(11,1:endplot))
plot(1:endplot,ee(12,1:endplot))
plot(1:endplot,ee(13,1:endplot))
plot(1:endplot,ee(14,1:endplot))
plot(1:endplot,ee(15,1:endplot))
%}

xlim([0,10000])
ylim([0,5]);

%legend('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15')
title(['Error of Each Number:iteration',num2str(iteration)])

%% testing 

T = zeros(1,3,45); %1~5를 각각 5x5로 나타냄 

%gleason score 6
T(:,:,1)=[1 -1 -1];    
T(:,:,2)=[1	-1 -1];  
T(:,:,3)=[2	0 -1];      
T(:,:,4)=[0	-1 -1];   
T(:,:,5)=[1	-1 -1];
T(:,:,6)=[0	-2 -1];
T(:,:,7)=[2	0 -1];
T(:,:,8)=[2 0 0];
T(:,:,9)=[2 -1 0];
%gleason score 7
T(:,:,10)=[1 -1 0];
T(:,:,11)=[0 0 -1];
T(:,:,12)=[2 -1 -1];
T(:,:,13)=[2 0 0];
T(:,:,14)=[2 -1 0];  
T(:,:,15)=[2 -1	-1];
T(:,:,16)=[0 0 0];
T(:,:,17)=[1 0 -1];
T(:,:,18)=[0 0 0];
%gleason score 8
T(:,:,19)=[2 -2	-1];
T(:,:,20)=[2 -1	-1];
T(:,:,21)=[1 -1	0];
T(:,:,22)=[0 -2 -1];
T(:,:,23)=[2 -1 -1];
T(:,:,24)=[2 -1 -1];
T(:,:,25)=[1 -1 -1];
T(:,:,26)=[0 0 -1];
T(:,:,27)=[0 -1 0];
%gleason score 9
T(:,:,28)=[2 -1 0];
T(:,:,29)=[2 -1 -1];
T(:,:,30)=[2 -1 -1];
T(:,:,31)=[1 1 -1];
T(:,:,32)=[2 -1	0];
T(:,:,33)=[2 -1 0];
T(:,:,34)=[2 0 -2];
T(:,:,35)=[2 0 0];
T(:,:,36)=[2 -1 -1];
%gleason score 10
T(:,:,37)=[2 -1 -1];
T(:,:,38)=[2 1 -2];
T(:,:,39)=[0 -2 -1];
T(:,:,40)=[2 -1 -1];
T(:,:,41)=[2 0 0];
T(:,:,42)=[0 0 -1];
T(:,:,43)=[2 -1 -1];
T(:,:,44)=[1 -1 0];
T(:,:,45)=[0 -1 -1];

N=size(T,3);
test=zeros(5,N);
for k=1:N
    t=reshape(T(:,:,k),3,1);
    
    z1=W1'*t;
    x1=LeakyReLU(z1);
    
    z2=W2'*x1;
    x2=LeakyReLU(z2);
    
    z3=W3'*x2;
    x3=LeakyReLU(z3);
   
    z4=W4'*x3;
    x4=LeakyReLU(z4);
   
    z5=W5'*x4;
    x5=LeakyReLU(z5);
   
    z6=W6'*x5;
    x6=LeakyReLU(z6);
   
    z7=W7'*x6;
    x7=LeakyReLU(z7);
   
    z8=W8'*x7;
    x8=LeakyReLU(z8);
   
    z9=W9'*x8;
    x9=LeakyReLU(z9);
    
    z10=W10'*x9;
    x10=LeakyReLU(z10);
   
    z11=W11'*x10;
    
    yhat=Softmax(z11)
    
    test(:,k)=yhat;
    
end

disp('-------------------------testing')
